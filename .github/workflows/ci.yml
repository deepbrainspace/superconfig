name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Setup job runs first, installs all tools and populates caches
  setup:
    name: Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system
        uses: ./.github/actions/setup-moon
        with:
          rust-version: stable

      - name: Debug Moon environment
        run: |
          echo "Current directory: $(pwd)"
          echo "Moon version: $(moon --version)"
          echo "Proto version: $(proto --version)"
          echo "Rust version: $(rustc --version)"
          ls -la

      - name: Test Moon basic functionality
        run: |
          moon --version
          moon query projects

  # All subsequent jobs depend on setup and use cached tools
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system (cached)
        uses: ./.github/actions/setup-moon
        with:
          rust-version: stable
          
      - name: Run Moon checks
        run: moon check --all

      - name: Run tests (Moon)
        run: moon run :test --query="language=rust"

      - name: Run doc tests (Moon)
        run: moon run :test-doc --query="language=rust"

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system (cached)
        uses: ./.github/actions/setup-moon
        with:
          rust-version: stable

      - name: Check formatting
        run: moon run :fmt-check --query="language=rust"

      - name: Run clippy
        run: moon run :clippy --query="language=rust"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        profile: ["dev", "release"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system (cached)
        uses: ./.github/actions/setup-moon
        with:
          rust-version: stable

      - name: Build with Moon
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            moon run :build --query="language=rust" -- --release
          else
            moon run :build --query="language=rust"
          fi

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system (cached)
        uses: ./.github/actions/setup-moon
        with:
          rust-version: stable

      - name: Run security audit (Moon)
        run: moon run :security-audit --query="language=rust"
        
      - name: Run cargo deny checks (Moon)
        run: moon run :deny --query="language=rust"

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system (cached)
        uses: ./.github/actions/setup-moon
        with:
          rust-version: stable

      - name: Generate coverage report
        run: moon run :coverage --query="language=rust"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./cobertura.xml
          fail_ci_if_error: false