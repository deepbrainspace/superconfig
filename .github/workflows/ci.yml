name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: ["1.86", "stable"]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system
        uses: ./.github/actions/setup-moon
        with:
          rust-version: ${{ matrix.rust-version }}

      - name: Debug Moon environment
        run: |
          echo "Current directory: $(pwd)"
          echo "Moon version: $(moon --version)"
          echo "Proto version: $(proto --version)"
          echo "Rust version: $(rustc --version)"
          ls -la

      - name: Test Moon basic functionality
        run: |
          moon --version
          moon query projects
          
      - name: Run Moon checks (with verbose logging)
        run: moon check --all --log trace

      - name: Run tests (Moon)
        run: moon run :test --query="language=rust"

      - name: Run doc tests (Moon)
        run: moon run :test-doc --query="language=rust"

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system
        uses: ./.github/actions/setup-moon

      - name: Check formatting
        run: moon run :fmt-check --query="language=rust"

      - name: Run clippy
        run: moon run :clippy --query="language=rust"

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: ["dev", "release"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system
        uses: ./.github/actions/setup-moon

      - name: Build with Moon
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            moon run :build --query="language=rust" -- --release
          else
            moon run :build --query="language=rust"
          fi

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate time-based cache key for security audits
        id: security-cache
        run: |
          # Create 6-hour time windows (4 periods per day: 00, 06, 12, 18)
          TIME_WINDOW=$(date +%Y%m%d%H | awk '{print int($1/6)*6}')
          echo "window=$TIME_WINDOW" >> $GITHUB_OUTPUT

      - name: Setup Moon build system
        uses: ./.github/actions/setup-moon

      - name: Cache security audit results
        uses: actions/cache@v4
        with:
          path: .moon/cache/outputs/**/security-audit
          key: security-audit-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}-${{ steps.security-cache.outputs.window }}
          restore-keys: |
            security-audit-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}-

      - name: Run security audit (Moon)
        run: moon run :security-audit --query="language=rust"

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon build system
        uses: ./.github/actions/setup-moon

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        run: cargo tarpaulin --verbose --all-features --workspace --timeout 120 --out xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./cobertura.xml
          fail_ci_if_error: false